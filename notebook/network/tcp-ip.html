<!DOCTYPE html>
<html lang="zh-CN">
<head>
<!-- 2021-01-09 周六 19:44 -->
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>TCP/IP 相关</title>
<meta name="generator" content="Org mode">
<style type="text/css">
 <!--/*--><![CDATA[/*><!--*/
  .title  { text-align: center;
             margin-bottom: .2em; }
  .subtitle { text-align: center;
              font-size: medium;
              font-weight: bold;
              margin-top:0; }
  .todo   { font-family: monospace; color: red; }
  .done   { font-family: monospace; color: green; }
  .priority { font-family: monospace; color: orange; }
  .tag    { background-color: #eee; font-family: monospace;
            padding: 2px; font-size: 80%; font-weight: normal; }
  .timestamp { color: #bebebe; }
  .timestamp-kwd { color: #5f9ea0; }
  .org-right  { margin-left: auto; margin-right: 0px;  text-align: right; }
  .org-left   { margin-left: 0px;  margin-right: auto; text-align: left; }
  .org-center { margin-left: auto; margin-right: auto; text-align: center; }
  .underline { text-decoration: underline; }
  #postamble p, #preamble p { font-size: 90%; margin: .2em; }
  p.verse { margin-left: 3%; }
  pre {
    border: 1px solid #ccc;
    box-shadow: 3px 3px 3px #eee;
    padding: 8pt;
    font-family: monospace;
    overflow: auto;
    margin: 1.2em;
  }
  pre.src {
    position: relative;
    overflow: visible;
    padding-top: 1.2em;
  }
  pre.src:before {
    display: none;
    position: absolute;
    background-color: white;
    top: -10px;
    right: 10px;
    padding: 3px;
    border: 1px solid black;
  }
  pre.src:hover:before { display: inline;}
  /* Languages per Org manual */
  pre.src-asymptote:before { content: 'Asymptote'; }
  pre.src-awk:before { content: 'Awk'; }
  pre.src-C:before { content: 'C'; }
  /* pre.src-C++ doesn't work in CSS */
  pre.src-clojure:before { content: 'Clojure'; }
  pre.src-css:before { content: 'CSS'; }
  pre.src-D:before { content: 'D'; }
  pre.src-ditaa:before { content: 'ditaa'; }
  pre.src-dot:before { content: 'Graphviz'; }
  pre.src-calc:before { content: 'Emacs Calc'; }
  pre.src-emacs-lisp:before { content: 'Emacs Lisp'; }
  pre.src-fortran:before { content: 'Fortran'; }
  pre.src-gnuplot:before { content: 'gnuplot'; }
  pre.src-haskell:before { content: 'Haskell'; }
  pre.src-hledger:before { content: 'hledger'; }
  pre.src-java:before { content: 'Java'; }
  pre.src-js:before { content: 'Javascript'; }
  pre.src-latex:before { content: 'LaTeX'; }
  pre.src-ledger:before { content: 'Ledger'; }
  pre.src-lisp:before { content: 'Lisp'; }
  pre.src-lilypond:before { content: 'Lilypond'; }
  pre.src-lua:before { content: 'Lua'; }
  pre.src-matlab:before { content: 'MATLAB'; }
  pre.src-mscgen:before { content: 'Mscgen'; }
  pre.src-ocaml:before { content: 'Objective Caml'; }
  pre.src-octave:before { content: 'Octave'; }
  pre.src-org:before { content: 'Org mode'; }
  pre.src-oz:before { content: 'OZ'; }
  pre.src-plantuml:before { content: 'Plantuml'; }
  pre.src-processing:before { content: 'Processing.js'; }
  pre.src-python:before { content: 'Python'; }
  pre.src-R:before { content: 'R'; }
  pre.src-ruby:before { content: 'Ruby'; }
  pre.src-sass:before { content: 'Sass'; }
  pre.src-scheme:before { content: 'Scheme'; }
  pre.src-screen:before { content: 'Gnu Screen'; }
  pre.src-sed:before { content: 'Sed'; }
  pre.src-sh:before { content: 'shell'; }
  pre.src-sql:before { content: 'SQL'; }
  pre.src-sqlite:before { content: 'SQLite'; }
  /* additional languages in org.el's org-babel-load-languages alist */
  pre.src-forth:before { content: 'Forth'; }
  pre.src-io:before { content: 'IO'; }
  pre.src-J:before { content: 'J'; }
  pre.src-makefile:before { content: 'Makefile'; }
  pre.src-maxima:before { content: 'Maxima'; }
  pre.src-perl:before { content: 'Perl'; }
  pre.src-picolisp:before { content: 'Pico Lisp'; }
  pre.src-scala:before { content: 'Scala'; }
  pre.src-shell:before { content: 'Shell Script'; }
  pre.src-ebnf2ps:before { content: 'ebfn2ps'; }
  /* additional language identifiers per "defun org-babel-execute"
       in ob-*.el */
  pre.src-cpp:before  { content: 'C++'; }
  pre.src-abc:before  { content: 'ABC'; }
  pre.src-coq:before  { content: 'Coq'; }
  pre.src-groovy:before  { content: 'Groovy'; }
  /* additional language identifiers from org-babel-shell-names in
     ob-shell.el: ob-shell is the only babel language using a lambda to put
     the execution function name together. */
  pre.src-bash:before  { content: 'bash'; }
  pre.src-csh:before  { content: 'csh'; }
  pre.src-ash:before  { content: 'ash'; }
  pre.src-dash:before  { content: 'dash'; }
  pre.src-ksh:before  { content: 'ksh'; }
  pre.src-mksh:before  { content: 'mksh'; }
  pre.src-posh:before  { content: 'posh'; }
  /* Additional Emacs modes also supported by the LaTeX listings package */
  pre.src-ada:before { content: 'Ada'; }
  pre.src-asm:before { content: 'Assembler'; }
  pre.src-caml:before { content: 'Caml'; }
  pre.src-delphi:before { content: 'Delphi'; }
  pre.src-html:before { content: 'HTML'; }
  pre.src-idl:before { content: 'IDL'; }
  pre.src-mercury:before { content: 'Mercury'; }
  pre.src-metapost:before { content: 'MetaPost'; }
  pre.src-modula-2:before { content: 'Modula-2'; }
  pre.src-pascal:before { content: 'Pascal'; }
  pre.src-ps:before { content: 'PostScript'; }
  pre.src-prolog:before { content: 'Prolog'; }
  pre.src-simula:before { content: 'Simula'; }
  pre.src-tcl:before { content: 'tcl'; }
  pre.src-tex:before { content: 'TeX'; }
  pre.src-plain-tex:before { content: 'Plain TeX'; }
  pre.src-verilog:before { content: 'Verilog'; }
  pre.src-vhdl:before { content: 'VHDL'; }
  pre.src-xml:before { content: 'XML'; }
  pre.src-nxml:before { content: 'XML'; }
  /* add a generic configuration mode; LaTeX export needs an additional
     (add-to-list 'org-latex-listings-langs '(conf " ")) in .emacs */
  pre.src-conf:before { content: 'Configuration File'; }

  table { border-collapse:collapse; }
  caption.t-above { caption-side: top; }
  caption.t-bottom { caption-side: bottom; }
  td, th { vertical-align:top;  }
  th.org-right  { text-align: center;  }
  th.org-left   { text-align: center;   }
  th.org-center { text-align: center; }
  td.org-right  { text-align: right;  }
  td.org-left   { text-align: left;   }
  td.org-center { text-align: center; }
  dt { font-weight: bold; }
  .footpara { display: inline; }
  .footdef  { margin-bottom: 1em; }
  .figure { padding: 1em; }
  .figure p { text-align: center; }
  .equation-container {
    display: table;
    text-align: center;
    width: 100%;
  }
  .equation {
    vertical-align: middle;
  }
  .equation-label {
    display: table-cell;
    text-align: right;
    vertical-align: middle;
  }
  .inlinetask {
    padding: 10px;
    border: 2px solid gray;
    margin: 10px;
    background: #ffffcc;
  }
  #org-div-home-and-up
   { text-align: right; font-size: 70%; white-space: nowrap; }
  textarea { overflow-x: auto; }
  .linenr { font-size: smaller }
  .code-highlighted { background-color: #ffff00; }
  .org-info-js_info-navigation { border-style: none; }
  #org-info-js_console-label
    { font-size: 10px; font-weight: bold; white-space: nowrap; }
  .org-info-js_search-highlight
    { background-color: #ffff00; color: #000000; font-weight: bold; }
  .org-svg { width: 90%; }
  /*]]>*/-->
</style>
<link rel="stylesheet" type="text/css" href="https://rgb-24bit.github.io/blog/misc/style.css">
<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-125860001-1"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-125860001-1');
</script>
<script type="text/javascript">
/*
@licstart  The following is the entire license notice for the
JavaScript code in this tag.

Copyright (C) 2012-2020 Free Software Foundation, Inc.

The JavaScript code in this tag is free software: you can
redistribute it and/or modify it under the terms of the GNU
General Public License (GNU GPL) as published by the Free Software
Foundation, either version 3 of the License, or (at your option)
any later version.  The code is distributed WITHOUT ANY WARRANTY;
without even the implied warranty of MERCHANTABILITY or FITNESS
FOR A PARTICULAR PURPOSE.  See the GNU GPL for more details.

As additional permission under GNU GPL version 3 section 7, you
may distribute non-source (e.g., minimized or compacted) forms of
that code without the copy of the GNU GPL normally required by
section 4, provided you include this license notice and a URL
through which recipients can access the Corresponding Source.


@licend  The above is the entire license notice
for the JavaScript code in this tag.
*/
<!--/*--><![CDATA[/*><!--*/
 function CodeHighlightOn(elem, id)
 {
   var target = document.getElementById(id);
   if(null != target) {
     elem.cacheClassElem = elem.className;
     elem.cacheClassTarget = target.className;
     target.className = "code-highlighted";
     elem.className   = "code-highlighted";
   }
 }
 function CodeHighlightOff(elem, id)
 {
   var target = document.getElementById(id);
   if(elem.cacheClassElem)
     elem.className = elem.cacheClassElem;
   if(elem.cacheClassTarget)
     target.className = elem.cacheClassTarget;
 }
/*]]>*///-->
</script>
</head>
<body>
<div id="org-div-home-and-up">
 <a accesskey="h" href="https://rgb-24bit.github.io/notebook/"> UP </a>
 |
 <a accesskey="H" href="https://rgb-24bit.github.io"> HOME </a>
</div><div id="content">
<h1 class="title">TCP/IP 相关</h1>
<div id="table-of-contents">
<h2>&#30446;&#24405;</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#orgca6aab4">1. TCP 流量控制和拥塞控制</a></li>
<li><a href="#orga723957">2. TCP &amp; UDP</a></li>
<li><a href="#org8901837">3. 相关问题</a>
<ul>
<li><a href="#org9f22f7a">3.1. TCP 面向连接和 UDP 无连接的理解</a></li>
<li><a href="#org163e5c5">3.2. TCP 和 UDP 使用场景</a></li>
</ul>
</li>
</ul>
</div>
</div>

<div id="outline-container-orgca6aab4" class="outline-2">
<h2 id="orgca6aab4"><span class="section-number-2">1</span> TCP 流量控制和拥塞控制</h2>
<div class="outline-text-2" id="text-1">
<p>
TCP 中为了尽可能的利用信道的传输能力，会一次性发送多个数据报等待对方确认，但是这样做存在两个问题：
</p>
<ol class="org-ol">
<li>接收方的接收窗口未必能一次性接收这么多数据</li>
<li>网络的带宽也不一定足够大，容易出现丢包事故</li>
</ol>

<p>
为了解决这两个问题，TCP 便通过 <b>滑动窗口</b> 和 <b>拥塞控制</b> 来确定发送窗口的大小，其中：
</p>
<ul class="org-ul">
<li>滑动窗口通过接收方的确认数据包中指定的窗口大小来确定发送窗口大小</li>
<li>拥塞控制通过拥塞控制算法来确定发送窗口的大小</li>
</ul>

<p>
因此，发送窗口的大小取滑动窗口和拥塞控制两者确定的最小值。
</p>

<p>
滑动窗口机制中窗口大小由接受方给出，较为直接，相对复杂的是滑动窗口中的数据重传机制，分为两种情况：
</p>
<ol class="org-ol">
<li>确认应答包丢失，这时，由于存在滑动窗口，只要发送方接受到了后续的确认应答包，那么，也就不需要重传</li>
<li>发送数据包丢失，这时，虽然发送方还是在不断的发送数据，但是，接受方发现之前的数据报一直没来时，就会一直重发对应的确认应答包，这时，当发送方发现重复次数达到 3 时就会重复数据包</li>
</ol>

<p>
这也被称为连续 ARQ 协议，但是，当没有使用滑动窗口时，便需要使用停止等待 ARQ 协议，基本原理就是每发完一个分组就停止发送，等待对方确认。如果过了一段时间，还是没有收到 ACK 确认，说明没有发送成功，需要重新发送，直到收到确认后再发下一个分组。
</p>

<p>
在停止等待协议中，若接收方收到重复分组，就丢弃该分组，但同时还要发送确认，这时为了保证出现差错时不出现问题：
</p>
<ul class="org-ul">
<li>确认丢失：确认消息在传输过程丢失。当 A 发送 M1 消息，B 收到后，B 向 A 发送了一个 M1 确认消息，但却在传输过程中丢失。而 A 并不知道，在超时计时过后，A 重传 M1 消息，
B 再次收到该消息后采取以下两点措施：
<ol class="org-ol">
<li>丢弃这个重复的 M1 消息，不向上层交付</li>
<li>向 A 发送确认消息（不会认为已经发送过了，就不再发送。A 能重传，就证明 B 的确认消息丢失）</li>
</ol></li>
<li>确认迟到：确认消息在传输过程中迟到。A 发送 M1 消息，B 收到并发送确认。在超时时间内没有收到确认消息，A 重传 M1 消息，B 仍然收到并继续发送确认消息（B 收到了 2 份 M1）。此时 A 收到了 B 第二次发送的确认消息。接着发送其他数据。过了一会，A 收到了 B 第一次发送的对 M1 的确认消息（A 也收到了 2 份确认消息）。处理如下：
<ol class="org-ol">
<li>A 收到重复的确认后，直接丢弃</li>
<li>B 收到重复的 M1 后，也直接丢弃重复的 M1</li>
</ol></li>
</ul>

<p>
然后是拥塞控制，主要是四个算法：
</p>
<ol class="org-ol">
<li>慢开始算法，刚建立连接时将拥塞窗口设为 1 个 MSS 大小，每收到一个对新的报文段的确认后，将拥塞窗口增加至多一个 MSS 的数值，这个阶段窗口大小是指数增长的</li>
<li>拥塞避免算法，因为拥塞窗口是指数增长的，为防止后期增长过快，需要另外一个变量 - 慢开始门限 ssthres，当 cwind == ssthress 时，要预防拥塞的产生，开始执行拥塞避免算法，
cwnd 按线性规律增长，一个 RTT 增长 1</li>
<li>快重传算法，就是使用滑动窗口时，一连收到三个重复的 ACK 即可断定有分组丢失了，就应立即重传丢失的报文段而不必继续等待为该报文段设置的重传计时器的超时</li>
<li>快恢复算法，当发送方连续收到三个重复确认时，就执行乘法减小算法，把慢开始门限减半，预防网络发生拥塞，同时把 cwnd 值设置为慢开始门限减半后的值，然后开始执行拥塞避免算法，是拥塞窗口的线性增大</li>
</ol>

<p>
旧的拥塞控制中，没有使用快重传和快恢复算法时，当网络发生拥塞（即没有在 TTL 时间内接收到确认数据报，确认超时），就把 ssthresh 值更新为拥塞前 cwind 值的一半，
cwnd 重新设置为 1，从新执行慢开始算法。
</p>

<p>
参考：
</p>
<ul class="org-ul">
<li><a href="https://segmentfault.com/a/1190000011641120">TCP 流量控制和拥塞控制 - 个人文章 - SegmentFault 思否</a></li>
<li><a href="https://www.cnblogs.com/iou123lg/p/9017044.html">TCP 流量控制和拥塞控制 - lingjiango - 博客园</a></li>
<li><a href="http://c.biancheng.net/view/6427.html">TCP 滑动窗口机制深度剖析</a></li>
</ul>
</div>
</div>

<div id="outline-container-orga723957" class="outline-2">
<h2 id="orga723957"><span class="section-number-2">2</span> TCP &amp; UDP</h2>
<div class="outline-text-2" id="text-2">
<dl class="org-dl">
<dt>TCP 首部</dt><dd><img src="https://user-gold-cdn.xitu.io/2019/7/13/16bea56ed5a68bb6?imageView2/0/w/1280/h/960/format/webp/ignore-error/1"></dd>
<dt>UDP 首部</dt><dd><img src="https://user-gold-cdn.xitu.io/2019/7/14/16bee3ea3304bc7e?imageView2/0/w/1280/h/960/format/webp/ignore-error/1"></dd>
</dl>
</div>
</div>


<div id="outline-container-org8901837" class="outline-2">
<h2 id="org8901837"><span class="section-number-2">3</span> 相关问题</h2>
<div class="outline-text-2" id="text-3">
</div>
<div id="outline-container-org9f22f7a" class="outline-3">
<h3 id="org9f22f7a"><span class="section-number-3">3.1</span> TCP 面向连接和 UDP 无连接的理解</h3>
<div class="outline-text-3" id="text-3-1">
<p>
都说 TCP 是面向连接的协议而 UDP 是无连接的，那么，什么是连接呢？没能在网上找到合适的答案，只能给一个能够说服自己的。
</p>

<p>
通过 TCP 协议传输数据的两方，在开始传输数据之前需要通过 <b>三次握手</b> 的过程来交换彼此之间的一些配置信息，同时会通过一系列的措施来保证数据传输的可靠型。
</p>

<p>
但是对于 UDP 来说，传输数据只需要知道目标 IP 和端口号就行了，不需要通过复杂的流程来保证数据传输的可靠性。
</p>

<p>
因此，个人理解：连接就是通过一些措施来保证通信的双方能够知晓对方的状况，而无连接，就是不需要知晓对方的状况就可以直接发送数据的方式。
</p>
</div>
</div>

<div id="outline-container-org163e5c5" class="outline-3">
<h3 id="org163e5c5"><span class="section-number-3">3.2</span> TCP 和 UDP 使用场景</h3>
<div class="outline-text-3" id="text-3-2">
<p>
TCP 通过三次握手、ACK 机制、首部校验和等措施保证了数据传输的可靠性：我传给你的数据你确定收到了，没有遗失，但不能保证不会被串改。
</p>

<p>
当然了，TCP 提供的只是可靠的运输服务，安全性需要由上层协议来保证。
</p>

<p>
UDP 数据运输只能通过校验和保证数据传输没有出错，但不能保证对方收到数据及收到数据的顺序。
</p>

<p>
因此，两者的适用场景为：
</p>
<ul class="org-ul">
<li>TCP - 需要可靠数据传输的场景</li>
<li>UDP - 能够容忍丢包的场景</li>
</ul>
</div>
</div>
</div>
</div>
<div id="postamble" class="status">
版权声明：本作品采用<a rel="license" href="http://creativecommons.org/licenses/by-nc/4.0/">知识共享署名-非商业性使用 4.0 国际许可协议</a>进行许可
<div id="disqus_thread"></div>
<script type="text/javascript">
  var disqus_shortname = 'rgb-24bit';
  (function() {
    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
  })();
</script>
</div>
</body>
</html>
