<!DOCTYPE html>
<html lang="zh-CN">
<head>
<!-- 2021-01-09 周六 19:46 -->
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>J.U.C</title>
<meta name="generator" content="Org mode">
<style type="text/css">
 <!--/*--><![CDATA[/*><!--*/
  .title  { text-align: center;
             margin-bottom: .2em; }
  .subtitle { text-align: center;
              font-size: medium;
              font-weight: bold;
              margin-top:0; }
  .todo   { font-family: monospace; color: red; }
  .done   { font-family: monospace; color: green; }
  .priority { font-family: monospace; color: orange; }
  .tag    { background-color: #eee; font-family: monospace;
            padding: 2px; font-size: 80%; font-weight: normal; }
  .timestamp { color: #bebebe; }
  .timestamp-kwd { color: #5f9ea0; }
  .org-right  { margin-left: auto; margin-right: 0px;  text-align: right; }
  .org-left   { margin-left: 0px;  margin-right: auto; text-align: left; }
  .org-center { margin-left: auto; margin-right: auto; text-align: center; }
  .underline { text-decoration: underline; }
  #postamble p, #preamble p { font-size: 90%; margin: .2em; }
  p.verse { margin-left: 3%; }
  pre {
    border: 1px solid #ccc;
    box-shadow: 3px 3px 3px #eee;
    padding: 8pt;
    font-family: monospace;
    overflow: auto;
    margin: 1.2em;
  }
  pre.src {
    position: relative;
    overflow: visible;
    padding-top: 1.2em;
  }
  pre.src:before {
    display: none;
    position: absolute;
    background-color: white;
    top: -10px;
    right: 10px;
    padding: 3px;
    border: 1px solid black;
  }
  pre.src:hover:before { display: inline;}
  /* Languages per Org manual */
  pre.src-asymptote:before { content: 'Asymptote'; }
  pre.src-awk:before { content: 'Awk'; }
  pre.src-C:before { content: 'C'; }
  /* pre.src-C++ doesn't work in CSS */
  pre.src-clojure:before { content: 'Clojure'; }
  pre.src-css:before { content: 'CSS'; }
  pre.src-D:before { content: 'D'; }
  pre.src-ditaa:before { content: 'ditaa'; }
  pre.src-dot:before { content: 'Graphviz'; }
  pre.src-calc:before { content: 'Emacs Calc'; }
  pre.src-emacs-lisp:before { content: 'Emacs Lisp'; }
  pre.src-fortran:before { content: 'Fortran'; }
  pre.src-gnuplot:before { content: 'gnuplot'; }
  pre.src-haskell:before { content: 'Haskell'; }
  pre.src-hledger:before { content: 'hledger'; }
  pre.src-java:before { content: 'Java'; }
  pre.src-js:before { content: 'Javascript'; }
  pre.src-latex:before { content: 'LaTeX'; }
  pre.src-ledger:before { content: 'Ledger'; }
  pre.src-lisp:before { content: 'Lisp'; }
  pre.src-lilypond:before { content: 'Lilypond'; }
  pre.src-lua:before { content: 'Lua'; }
  pre.src-matlab:before { content: 'MATLAB'; }
  pre.src-mscgen:before { content: 'Mscgen'; }
  pre.src-ocaml:before { content: 'Objective Caml'; }
  pre.src-octave:before { content: 'Octave'; }
  pre.src-org:before { content: 'Org mode'; }
  pre.src-oz:before { content: 'OZ'; }
  pre.src-plantuml:before { content: 'Plantuml'; }
  pre.src-processing:before { content: 'Processing.js'; }
  pre.src-python:before { content: 'Python'; }
  pre.src-R:before { content: 'R'; }
  pre.src-ruby:before { content: 'Ruby'; }
  pre.src-sass:before { content: 'Sass'; }
  pre.src-scheme:before { content: 'Scheme'; }
  pre.src-screen:before { content: 'Gnu Screen'; }
  pre.src-sed:before { content: 'Sed'; }
  pre.src-sh:before { content: 'shell'; }
  pre.src-sql:before { content: 'SQL'; }
  pre.src-sqlite:before { content: 'SQLite'; }
  /* additional languages in org.el's org-babel-load-languages alist */
  pre.src-forth:before { content: 'Forth'; }
  pre.src-io:before { content: 'IO'; }
  pre.src-J:before { content: 'J'; }
  pre.src-makefile:before { content: 'Makefile'; }
  pre.src-maxima:before { content: 'Maxima'; }
  pre.src-perl:before { content: 'Perl'; }
  pre.src-picolisp:before { content: 'Pico Lisp'; }
  pre.src-scala:before { content: 'Scala'; }
  pre.src-shell:before { content: 'Shell Script'; }
  pre.src-ebnf2ps:before { content: 'ebfn2ps'; }
  /* additional language identifiers per "defun org-babel-execute"
       in ob-*.el */
  pre.src-cpp:before  { content: 'C++'; }
  pre.src-abc:before  { content: 'ABC'; }
  pre.src-coq:before  { content: 'Coq'; }
  pre.src-groovy:before  { content: 'Groovy'; }
  /* additional language identifiers from org-babel-shell-names in
     ob-shell.el: ob-shell is the only babel language using a lambda to put
     the execution function name together. */
  pre.src-bash:before  { content: 'bash'; }
  pre.src-csh:before  { content: 'csh'; }
  pre.src-ash:before  { content: 'ash'; }
  pre.src-dash:before  { content: 'dash'; }
  pre.src-ksh:before  { content: 'ksh'; }
  pre.src-mksh:before  { content: 'mksh'; }
  pre.src-posh:before  { content: 'posh'; }
  /* Additional Emacs modes also supported by the LaTeX listings package */
  pre.src-ada:before { content: 'Ada'; }
  pre.src-asm:before { content: 'Assembler'; }
  pre.src-caml:before { content: 'Caml'; }
  pre.src-delphi:before { content: 'Delphi'; }
  pre.src-html:before { content: 'HTML'; }
  pre.src-idl:before { content: 'IDL'; }
  pre.src-mercury:before { content: 'Mercury'; }
  pre.src-metapost:before { content: 'MetaPost'; }
  pre.src-modula-2:before { content: 'Modula-2'; }
  pre.src-pascal:before { content: 'Pascal'; }
  pre.src-ps:before { content: 'PostScript'; }
  pre.src-prolog:before { content: 'Prolog'; }
  pre.src-simula:before { content: 'Simula'; }
  pre.src-tcl:before { content: 'tcl'; }
  pre.src-tex:before { content: 'TeX'; }
  pre.src-plain-tex:before { content: 'Plain TeX'; }
  pre.src-verilog:before { content: 'Verilog'; }
  pre.src-vhdl:before { content: 'VHDL'; }
  pre.src-xml:before { content: 'XML'; }
  pre.src-nxml:before { content: 'XML'; }
  /* add a generic configuration mode; LaTeX export needs an additional
     (add-to-list 'org-latex-listings-langs '(conf " ")) in .emacs */
  pre.src-conf:before { content: 'Configuration File'; }

  table { border-collapse:collapse; }
  caption.t-above { caption-side: top; }
  caption.t-bottom { caption-side: bottom; }
  td, th { vertical-align:top;  }
  th.org-right  { text-align: center;  }
  th.org-left   { text-align: center;   }
  th.org-center { text-align: center; }
  td.org-right  { text-align: right;  }
  td.org-left   { text-align: left;   }
  td.org-center { text-align: center; }
  dt { font-weight: bold; }
  .footpara { display: inline; }
  .footdef  { margin-bottom: 1em; }
  .figure { padding: 1em; }
  .figure p { text-align: center; }
  .equation-container {
    display: table;
    text-align: center;
    width: 100%;
  }
  .equation {
    vertical-align: middle;
  }
  .equation-label {
    display: table-cell;
    text-align: right;
    vertical-align: middle;
  }
  .inlinetask {
    padding: 10px;
    border: 2px solid gray;
    margin: 10px;
    background: #ffffcc;
  }
  #org-div-home-and-up
   { text-align: right; font-size: 70%; white-space: nowrap; }
  textarea { overflow-x: auto; }
  .linenr { font-size: smaller }
  .code-highlighted { background-color: #ffff00; }
  .org-info-js_info-navigation { border-style: none; }
  #org-info-js_console-label
    { font-size: 10px; font-weight: bold; white-space: nowrap; }
  .org-info-js_search-highlight
    { background-color: #ffff00; color: #000000; font-weight: bold; }
  .org-svg { width: 90%; }
  /*]]>*/-->
</style>
<link rel="stylesheet" type="text/css" href="https://rgb-24bit.github.io/blog/misc/style.css">
<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-125860001-1"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-125860001-1');
</script>
<script type="text/javascript">
/*
@licstart  The following is the entire license notice for the
JavaScript code in this tag.

Copyright (C) 2012-2020 Free Software Foundation, Inc.

The JavaScript code in this tag is free software: you can
redistribute it and/or modify it under the terms of the GNU
General Public License (GNU GPL) as published by the Free Software
Foundation, either version 3 of the License, or (at your option)
any later version.  The code is distributed WITHOUT ANY WARRANTY;
without even the implied warranty of MERCHANTABILITY or FITNESS
FOR A PARTICULAR PURPOSE.  See the GNU GPL for more details.

As additional permission under GNU GPL version 3 section 7, you
may distribute non-source (e.g., minimized or compacted) forms of
that code without the copy of the GNU GPL normally required by
section 4, provided you include this license notice and a URL
through which recipients can access the Corresponding Source.


@licend  The above is the entire license notice
for the JavaScript code in this tag.
*/
<!--/*--><![CDATA[/*><!--*/
 function CodeHighlightOn(elem, id)
 {
   var target = document.getElementById(id);
   if(null != target) {
     elem.cacheClassElem = elem.className;
     elem.cacheClassTarget = target.className;
     target.className = "code-highlighted";
     elem.className   = "code-highlighted";
   }
 }
 function CodeHighlightOff(elem, id)
 {
   var target = document.getElementById(id);
   if(elem.cacheClassElem)
     elem.className = elem.cacheClassElem;
   if(elem.cacheClassTarget)
     target.className = elem.cacheClassTarget;
 }
/*]]>*///-->
</script>
</head>
<body>
<div id="org-div-home-and-up">
 <a accesskey="h" href="https://rgb-24bit.github.io/notebook/"> UP </a>
 |
 <a accesskey="H" href="https://rgb-24bit.github.io"> HOME </a>
</div><div id="content">
<h1 class="title">J.U.C</h1>
<div id="table-of-contents">
<h2>&#30446;&#24405;</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#orgd02a233">1. happends-before</a></li>
<li><a href="#org739cf76">2. monitor</a></li>
<li><a href="#org7825d74">3. Locks</a></li>
<li><a href="#org23e8301">4. atmoic</a></li>
<li><a href="#orgda7baad">5. concurrent</a>
<ul>
<li><a href="#org14b6f53">5.1. Executors</a></li>
<li><a href="#org8aff2e1">5.2. Queues</a></li>
<li><a href="#orge796456">5.3. Synchronizers</a></li>
<li><a href="#orgefa3156">5.4. Concurrent Collections</a>
<ul>
<li><a href="#orgab1ffeb">5.4.1. ConcurrentHashMap</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#org0970bec">6. 相关问题</a>
<ul>
<li><a href="#orgc46543b">6.1. 线程池大小设置</a></li>
<li><a href="#orgf3652ef">6.2. ConcurrentHashMap 大小必须是 2 的幂次的原因</a></li>
</ul>
</li>
</ul>
</div>
</div>

<div id="outline-container-orgd02a233" class="outline-2">
<h2 id="orgd02a233"><span class="section-number-2">1</span> happends-before</h2>
<div class="outline-text-2" id="text-1">
<p>
可以用来判断当一个操作 A 在时间上先于 B 发生时，这个操作是否就真的是先发生的，规则如下：
</p>
<ul class="org-ul">
<li>程序次序规则：在 <b>一个线程</b> 内，按照代码顺序，书写在前面的操作先行发生于书写在后面的操作</li>
<li>锁定规则：一个 unLock 操作先行发生于后面对同一个锁的 lock 操作</li>
<li>volatile 变量规则：对一个变量的写操作先行发生于后面对这个变量的读操作</li>
<li>传递规则：如果操作 A 先行发生于操作 B，而操作 B 又先行发生于操作 C，则可以得出操作 A 先行发生于操作 C</li>
<li>线程启动规则：Thread 对象的 start() 方法先行发生于此线程的每个一个动作</li>
<li>线程中断规则：对线程 interrupt() 方法的调用先行发生于被中断线程的代码检测到中断事件的发生</li>
<li>线程终结规则：线程中所有的操作都先行发生于线程的终止检测，我们可以通过 Thread.join() 方法结束、Thread.isAlive() 的返回值手段检测到线程已经终止执行</li>
<li>对象终结规则：一个对象的初始化完成先行发生于他的 finalize() 方法的开始</li>
</ul>

<p>
但是，时间上的先后和先行发生原则 <b>并没有</b> 直接的关系。
</p>

<p>
详见：《Java 并发编程实战》 P377
</p>

<p>
<code>java.util.concurrent</code> 对这样规则进行了增强：
</p>
<ul class="org-ul">
<li>将对象放入并发集合的操作 happends-before 访问移除集合中的该对象的操作</li>
<li>将 Runnale 放入 Executor 的操作 happends-before Runnale 的执行，Callables 到 ExecutorService 同理</li>
<li>通过 Future 代表的异步计算任务的执行 happends-before Future.get() 的返回</li>
<li>持有 Lock、Semaphore 等同步器的线程，在释放前的操作都 happends-before 其他线程获取 <b>成功</b> 同一个同步器之后的操作</li>
<li>对于通过交换程序成功交换对象的每对线程，每个线程中的 exchange() 之前的动作发生在另一个线程中相应的 exchange() 之后的动作之前</li>
<li>CyclicBarrier.await 和 Phaser.awaitAdvance 的调用 happends-before 屏障之后的操作，and actions performed by the barrier action happen-before actions subsequent to a successful return from the corresponding await in other threads.</li>
</ul>

<p>
参考：
</p>
<ul class="org-ul">
<li><a href="https://docs.oracle.com/javase/8/docs/api/java/util/concurrent/package-summary.html#MemoryVisibility">java.util.concurrent (Java Platform SE 8 )</a></li>
</ul>
</div>
</div>

<div id="outline-container-org739cf76" class="outline-2">
<h2 id="org739cf76"><span class="section-number-2">2</span> monitor</h2>
<div class="outline-text-2" id="text-2">
<p>
重量级锁由 ObjectMonitor 实现，ObjectMonitor 对象中有两个队列 WaitSet 和 EntrySet，用来保存 ObjectWaiter 对象列表，同时存在一个 Owner 指针指向拥有该 ObjectMonitor 的线程。
</p>

<p>
调用 Object.wait 方法时会释放锁并将该线程对应的 ObjectWaiter 放入 WaitSet，调用 notify 和 notifyAll 时，会从 WaitSet 随机选择一个或所有 ObjectWaiter 进行自选操作获取锁，或者放入 EntrySet，但是不会释放锁。
</p>

<img src="https://upload-images.jianshu.io/upload_images/2184951-9723bfce3c71c591.png?imageMogr2/auto-orient/strip|imageView2/2/w/533/format/webp">

<p>
参考：
</p>
<ul class="org-ul">
<li><a href="https://www.jianshu.com/p/f4454164c017">JVM 源码分析之 Object.wait/notify 实现 - 简书</a></li>
</ul>
</div>
</div>

<div id="outline-container-org7825d74" class="outline-2">
<h2 id="org7825d74"><span class="section-number-2">3</span> Locks</h2>
<div class="outline-text-2" id="text-3">
<p>
结构：
</p>
<div class="org-src-container">
<pre class="src src-plantuml">@startuml

Interface Lock {
  + lock()
  + lockInterruptibly()
  + newCondition() : Condition
  + tryLock()
  + tryLock(long time, TimeUnit unit)
  + unlock()
}

Interface ReadWriteLock {
  + readLock() : Lock
  + writeLock() : Lock
}

Interface Condition {
  + await()
  + await(long time, TimeUnit unit) : boolean
  + awaitNanos(long nanosTimeout) : long
  + awaitUninterruptibly()
  + awaitUntil(Date deadline) : boolean
  + signal()
  + signalAll()
}

Class ReentrantLock
Class ReentrantReadWriteLock

Lock &lt;|-- ReentrantLock 
ReadWriteLock &lt;|-- ReentrantReadWriteLock

@enduml
</pre>
</div>

<p>
JUC Locks 提供的三大件：
</p>
<ul class="org-ul">
<li>ReentrantLock(Lock) - 可重入锁，类似于内置锁，但是更加灵活</li>
<li>ReentrantReadWriteLock(ReadWriteLock) - 读写锁，读读不互斥，读写互斥，写写互斥，支持锁降级：获取写锁后在获取读锁，不支持锁升级：获取读锁后获取写锁。</li>
<li>Condition - 条件队列，对应 Object 的 wait 和 notify 方法使用</li>
</ul>

<img src="https://i.loli.net/2020/02/24/d35MZrENKqvhj6T.png">

<p>
JUC Locks 提供的基础工具：
</p>
<ul class="org-ul">
<li>AbstractOwnableSynchronizer - 线程专有的同步，AQS 继承了它</li>
<li><p>
AbstractQueuedSynchronizer - 大名鼎鼎的 AQS，提供一个框架，用于实现依赖于先进先出（FIFO）等待队列的阻塞锁和相关的同步器，其基本思想和 ObjectMonitor 是一样的：
</p>
<ul class="org-ul">
<li>获取锁时根据 state 的值判断是否能够获取到锁，获取不到的话就将当前线程对应的 Waiter 节点放入等待队列，然后通过循环的 CAS 操作尝试获取锁，一定时间获取不到在将线程挂起</li>
</ul>

<p>
参考：
</p>
<ul class="org-ul">
<li><a href="https://www.cnblogs.com/leesf456/p/5350186.html">JDK1.8 源码分析之 AbstractQueuedSynchronizer - leesf - 博客园</a></li>
<li><a href="https://juejin.im/post/5c3ac10351882524bb0b337f">AbstractQueuedSynchronizer 超详细原理解析 - 掘金</a></li>
</ul></li>
</ul>

<p>
官方文档：
</p>
<ul class="org-ul">
<li><a href="https://docs.oracle.com/javase/8/docs/api/java/util/concurrent/locks/AbstractQueuedSynchronizer.html">AbstractQueuedSynchronizer (Java Platform SE 8 )</a></li>
<li><a href="https://docs.oracle.com/javase/8/docs/api/java/util/concurrent/locks/package-summary.html">java.util.concurrent.locks (Java Platform SE 8 )</a></li>
</ul>
</div>
</div>

<div id="outline-container-org23e8301" class="outline-2">
<h2 id="org23e8301"><span class="section-number-2">4</span> atmoic</h2>
<div class="outline-text-2" id="text-4">
<p>
JUC Atmoic 相对来说要直接很多，大致就是通过 CAS 操作来更新旧值之类的……
</p>

<p>
参考：
</p>
<ul class="org-ul">
<li><a href="https://juejin.im/post/5bd93e91f265da396269d32f">并发编程面试必备：JUC 中的 Atomic 原子类总结 - 掘金</a></li>
</ul>
</div>
</div>

<div id="outline-container-orgda7baad" class="outline-2">
<h2 id="orgda7baad"><span class="section-number-2">5</span> concurrent</h2>
<div class="outline-text-2" id="text-5">
</div>
<div id="outline-container-org14b6f53" class="outline-3">
<h3 id="org14b6f53"><span class="section-number-3">5.1</span> Executors</h3>
<div class="outline-text-3" id="text-5-1">
<ul class="org-ul">
<li><a href="https://rgb-24bit.github.io/blog/2020/java-executor-framework.html">Java 并发之 Executor 框架</a></li>
</ul>
</div>
</div>

<div id="outline-container-org8aff2e1" class="outline-3">
<h3 id="org8aff2e1"><span class="section-number-3">5.2</span> Queues</h3>
<div class="outline-text-3" id="text-5-2">
<p>
JUC 提供了线程安全的无阻塞队列 ConcurrentLinkedQueue 和 ConcurrentLinkedDeque，但也提供了五种阻塞队列的实现：
</p>
<table>


<colgroup>
<col  class="org-left">

<col  class="org-left">
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">BlockingQueue</th>
<th scope="col" class="org-left">特点</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">ArrayBlockingQueue</td>
<td class="org-left">基于数组实现，有界队列</td>
</tr>

<tr>
<td class="org-left">LinkedBlockingQueue</td>
<td class="org-left">基于链表实现，可以有界也可以无界</td>
</tr>

<tr>
<td class="org-left">SynchronousQueue</td>
<td class="org-left">不保存元素</td>
</tr>

<tr>
<td class="org-left">PriorityBlockingQueue</td>
<td class="org-left">支持优先级排序的无界阻塞队列</td>
</tr>

<tr>
<td class="org-left">DelayQueue</td>
<td class="org-left">使用优先级队列实现的无界阻塞队列</td>
</tr>
</tbody>
</table>
</div>
</div>

<div id="outline-container-orge796456" class="outline-3">
<h3 id="orge796456"><span class="section-number-3">5.3</span> Synchronizers</h3>
<div class="outline-text-3" id="text-5-3">
<ul class="org-ul">
<li><a href="https://segmentfault.com/a/1190000015918459">Semaphore - 透彻理解 Java 并发编程 - SegmentFault 思否</a></li>
<li><a href="https://segmentfault.com/a/1190000015886497">CountDownLatch - 透彻理解 Java 并发编程 - SegmentFault 思否</a></li>
<li><a href="https://segmentfault.com/a/1190000015888316">CyclicBarrier - 透彻理解 Java 并发编程 - SegmentFault 思否</a></li>
<li><a href="https://segmentfault.com/a/1190000015979879">Phaser - 透彻理解 Java 并发编程 - SegmentFault 思否</a></li>
<li><a href="https://segmentfault.com/a/1190000015963932">Exchanger - 透彻理解 Java 并发编程 - SegmentFault 思否</a></li>
</ul>
</div>
</div>

<div id="outline-container-orgefa3156" class="outline-3">
<h3 id="orgefa3156"><span class="section-number-3">5.4</span> Concurrent Collections</h3>
<div class="outline-text-3" id="text-5-4">
</div>
<div id="outline-container-orgab1ffeb" class="outline-4">
<h4 id="orgab1ffeb"><span class="section-number-4">5.4.1</span> ConcurrentHashMap</h4>
<div class="outline-text-4" id="text-5-4-1">
<p>
ConcurrentHashMap 中当键不是 Comparable 时，通过如下方式比较节点大小：
</p>
<div class="org-src-container">
<pre class="src src-java"><span class="org-keyword">static</span> <span class="org-type">int</span> <span class="org-function-name">tieBreakOrder</span>(<span class="org-type">Object</span> <span class="org-variable-name">a</span>, <span class="org-type">Object</span> <span class="org-variable-name">b</span>) {
  <span class="org-type">int</span> <span class="org-variable-name">d</span>;
  <span class="org-keyword">if</span> (a == <span class="org-constant">null</span> || b == <span class="org-constant">null</span> ||
      (d = a.getClass().getName().
       compareTo(b.getClass().getName())) == 0)
    d = (System.identityHashCode(a) &lt;= System.identityHashCode(b) ?
         -1 : 1);
  <span class="org-keyword">return</span> d;
}
</pre>
</div>

<ul class="org-ul">
<li>System.identityHashCode - 获取通过对象内存地址计算出的 hash 值</li>
</ul>

<p>
ConcurrentHashMap 的 Get 操作：
</p>
<ol class="org-ol">
<li>首先根据 key 的 hash 值计算映射到 table 的哪个桶 table[i]</li>
<li>如果 table[i] 的 key 和待查找 key 相同，那直接返回 - 由于 Key 是 final 且 val 是 volatile 的，因此，能够保证读操作 happends-before 写操作</li>
<li>如果 table[i] 对应的结点是特殊结点，则通过 find 方法查找</li>
<li>如果 table[i] 对应的结点是普通链表结点，则按链表方式查找</li>
</ol>

<p>
当节点为 TreeBin 是，用了一种类似读写锁的方式，当有线程持有写锁时，如果读线程需要查找，不会像传统的读写锁那样阻塞等待，而是转而以链表的形式进行查找，否则添加读锁。
</p>

<p>
ConcurrentHashMap 的 Put 操作：
</p>
<ol class="org-ol">
<li>首先根据 key 计算 hash 值，然后通过 hash 值与 table 容量进行运算，计算得到 key 所映射的索引,也就是对应到 table 中桶的位置 i</li>
<li>当 table[i] 对应的桶为空，直接 CAS 操作占用桶 table[i] 即可</li>
<li>出现 hash 冲突，当 table[i] 的结点类型为 Node 时，就会将新结点以尾插法的形式插入链表的尾部，当 table[i] 的结点类型为 TreeBin 时，就会将新结点通过红黑树的插入方式插入</li>
</ol>
</div>
</div>
</div>
</div>

<div id="outline-container-org0970bec" class="outline-2">
<h2 id="org0970bec"><span class="section-number-2">6</span> 相关问题</h2>
<div class="outline-text-2" id="text-6">
</div>
<div id="outline-container-orgc46543b" class="outline-3">
<h3 id="orgc46543b"><span class="section-number-3">6.1</span> 线程池大小设置</h3>
<div class="outline-text-3" id="text-6-1">
<ul class="org-ul">
<li>线程饥饿死锁 - 在 Executor 中一个任务提交另一个任务到 Executor 到同一个 Executor 就可能导致死锁，特别是在单线程的 Executor 中</li>
<li>线程池大小设置：
<ol class="org-ol">
<li>CPU 密集型可以设置为：处理器数量 + 1</li>
<li>I/O 密集型可以设置为：处理器数量 * 处理器利用率 * (1 + 等待时间/计算时间)</li>
</ol></li>
</ul>
</div>
</div>

<div id="outline-container-orgf3652ef" class="outline-3">
<h3 id="orgf3652ef"><span class="section-number-3">6.2</span> ConcurrentHashMap 大小必须是 2 的幂次的原因</h3>
<div class="outline-text-3" id="text-6-2">
<p>
这是因为索引计算方式为 <code>i = (n - 1) &amp; hash</code>, 当 table.length 为 2 的幂次时，(table.length - 1) 的二进制形式的特点是除最高位外全部是 1，配合这种索引计算方式可以实现 key 在 table 中的均匀分布，减少 hash 冲突。
</p>
</div>
</div>
</div>
</div>
<div id="postamble" class="status">
版权声明：本作品采用<a rel="license" href="http://creativecommons.org/licenses/by-nc/4.0/">知识共享署名-非商业性使用 4.0 国际许可协议</a>进行许可
<div id="disqus_thread"></div>
<script type="text/javascript">
  var disqus_shortname = 'rgb-24bit';
  (function() {
    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
  })();
</script>
</div>
</body>
</html>
