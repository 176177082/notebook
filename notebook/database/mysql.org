#+TITLE:      MySQL

* 目录                                                    :TOC_4_gh:noexport:
- [[#安装与配置][安装与配置]]
- [[#注意事项][注意事项]]
- [[#问题集][问题集]]
  - [[#时区陷阱问题][时区陷阱问题]]
  - [[#怎样执行-sql-脚本][怎样执行 SQL 脚本]]
  - [[#怎样通过远程主机进行访问][怎样通过远程主机进行访问]]
  - [[#怎样在数据存在时更新不存在时插入][怎样在数据存在时更新不存在时插入]]

* 安装与配置
  + 安装指令：
    #+BEGIN_SRC bash
      apt-get install mariadb-server
    #+END_SRC

  + 配置外网访问：
    1. root 用户密码配置：
       #+BEGIN_SRC bash
         # 执行安全配置向导 - root 密码
         mysql_secure_installation
       #+END_SRC

    2. 更改配置项中的 ~bind-address~ 为 ~0.0.0.0~:
       #+BEGIN_SRC bash
         vim /etc/mysql/mariadb.conf.d/50-server.cnf
       #+END_SRC

    3. 创建拥有所有权限可远程访问的用户：
       #+BEGIN_SRC sql
         CREATE USER 'user'@'%' IDENTIFIED BY 'password';
         GRANT ALL PRIVILEGES ON *.* TO 'user'@'%' WITH GRANT OPTION;
         FLUSH PRIVILEGES;
       #+END_SRC

    4. 允许某用户进行远程主机访问：
       #+BEGIN_SRC sql
         > use mysql;
         > UPDATE USER SET HOST='%' WHERE user='user_name';
       #+END_SRC

    5. 重启服务
       #+BEGIN_SRC bash
         service mysql restart
       #+END_SRC

* 注意事项
  + 在 MySQL 中 LIMIT 不是子句，因此需要放在 ORDER BY 子句后面

* 问题集
** 时区陷阱问题
    ~mysql~ 6.0 以上的版本需要在链接字符串中假设参数 ~serverTimezone~ 指定时区：
    #+BEGIN_SRC xml
      <property name="url" value="jdbc:mysql://localhost:3306/springdatastudy?serverTimezone=UTC"/>
    #+END_SRC

    但是设置 ~UTC~ 时区可能导致时间精度的问题， 因此可以设置为中国标准时间：
    #+BEGIN_SRC xml
      <property name="url" value="jdbc:mysql://localhost:3306/springdatastudy?serverTimezone=Asia/Shanghai"/>
    #+END_SRC

** 怎样执行 SQL 脚本
    #+BEGIN_SRC bash
      mysql> source /path/to/script
    #+END_SRC

** 怎样通过远程主机进行访问
   + 更改配置文件中的 ~bind-address~ 为 ~0.0.0.0~, 配置文件在 ~/etc/mysql/~, 使得允许远程主机访问
   + 更改用户的 ~host~ 为 ~%~, 允许该用户进行远程访问
   + 通过如下方式创建拥有所有权限可远程访问的用户
     #+BEGIN_SRC sql
       CREATE USER 'user'@'%' IDENTIFIED BY 'password';

       GRANT ALL PRIVILEGES ON *.* TO 'user'@'%' = WITH GRANT OPTION;

       FLUSH PRIVILEGES;
     #+END_SRC

** 怎样在数据存在时更新不存在时插入
   #+BEGIN_SRC sql
     IF EXISTS(SELECT * FROM tbl WHERE id = 30122)
       UPDATE tbl SET name = 'john' WHERE id = 3012
     ELSE
       INSERT INTO tbl(name) VALUES('john');
   #+END_SRC

